---
title: "pilots_plot_results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

rm(list=ls())

pacman::p_load(pacman,
               tidyverse,
               rstatix,
               DT,
               kableExtra,
               readr,
               writexl,
               jsonlite,
               stringr,
               gridExtra,
               knitr,
               magrittr,
               pdist,
               gghighlight)


# Load the data ##########################
session_results_all_ptp <- import(
        './results/pilots/preprocessed_data/session_results_long_form.csv'
        )

session_results_all_ptp <- session_results_all_ptp %>%
        reorder_levels(condition, order = c('practice',
                                            'practice2',
                                            'schema_c',
                                            'schema_ic',
                                            'landmark_schema',
                                            'random_locations',
                                            'no_schema')
                       )

# Whats the order of conditions for this participant?
cond_order <- unique(session_results_all_ptp$condition)
cond_order <- c('schema_c','schema_ic','landmark_schema','random_locations',
                'no_schema')

# For each participant, make the same plot but ordered by condition order
condition_orders <- tibble(.rows = 7)

all_ptp <- unique(session_results_all_ptp$ptp)

for (iPtp in as.vector(all_ptp)){
        iPtp
        condition_orders[iPtp] <-
                unique(
                        session_results_all_ptp$condition[
                                session_results_all_ptp$ptp==iPtp
                                ])
}


```

```{r each-ptp-separately, fig.width=15, fig.height=15}


## Plot separately for each participant ----------------------------------------

# get the average performance across the targets, by repetition
mean_by_rep <-
        session_results_all_ptp %>%
        filter(!condition %in% c('practice','practice2')) %>%
        droplevels() %>%
        mutate(correct_rad_63 = coalesce(correct_rad_63,0)) %>%
        group_by(ptp_trunk,condition,session,new_pa_img_row_number) %>%
        summarize(correct_rad_63_mean = mean(correct_rad_63, na.rm = T),
                  correct_rad_63_sd = sd(correct_rad_63, na.rm = T)) %>%
        ungroup()

# Calculate mean for neighbor vs non neighbor
mean_by_landmark_rep <-
        session_results_all_ptp %>%
        filter(!condition %in% c('practice','practice2')) %>%
        mutate(correct_rad_63 = coalesce(correct_rad_63,0)) %>%
        group_by(ptp_trunk,condition,session,adjascent_neighbor,new_pa_img_row_number) %>%
        summarize(correct_rad_63_mean = mean(correct_rad_63, na.rm = T),
                  correct_rad_63_sd = sd(correct_rad_63, na.rm = T)) %>%
        ungroup() %>%
        mutate(correct_rad_63_mean = 
                       case_when(
                               is.na(adjascent_neighbor) ~ as.numeric(NA),
                               TRUE ~ correct_rad_63_mean
                               ),
               correct_rad_63_sd =
                       case_when(
                               is.na(adjascent_neighbor) ~ as.numeric(NA),
                               TRUE ~ correct_rad_63_sd
                       ),
               )

fig <- mean_by_rep %>%
        ggplot(aes(x=new_pa_img_row_number,y=correct_rad_63_mean)) +
        # Add the average across toys
        geom_point(data = mean_by_rep,
                   aes(y=correct_rad_63_mean)) +
        geom_line(data = mean_by_rep,
                  aes(y=correct_rad_63_mean),
                  size=2) +

        # Add the average across landmark or not
        geom_point(data = mean_by_landmark_rep, 
                   aes(group=adjascent_neighbor,
                       color=adjascent_neighbor,
                       y=correct_rad_63_mean)) +
        geom_line(data = mean_by_landmark_rep, 
                  aes(group=adjascent_neighbor,
                      color=adjascent_neighbor,
                      y=correct_rad_63_mean),
                  size=1) +
        
        facet_grid(ptp_trunk~condition*session) +
        ggtitle(paste('Accuracy type: 63px radius',sep='')) +
        theme(legend.position = 'none') +
        xlab('Image repetition') +
        scale_x_continuous(breaks=c(1,2,3,4))        

# fig <- session_results_all_ptp %>%
#         filter(!condition %in% c('practice','practice2')) %>%
#         droplevels() %>%
#         # reorder_levels(condition, order = cond_order) %>%
#         mutate(correct_rad_63 = coalesce(correct_rad_63,0)) %>%
#         group_by(ptp_trunk,condition,session,new_pa_img) %>%
#         
#         ggplot(aes(x=new_pa_img_row_number,y=correct_rad_63)) +
#         geom_point(aes(group=new_pa_img),
#                    alpha=0.2) +
#         geom_line(aes(group=new_pa_img),
#                   alpha=0.2) +
# 
#         # Add the average across toys
#         geom_point(data = mean_by_rep,
#                    aes(y=correct_rad_63_mean)) +
#         geom_line(data = mean_by_rep,
#                   aes(y=correct_rad_63_mean),
#                   size=2) +
# 
#         # Add the average across landmark or not
#         geom_point(data = mean_by_landmark_rep, 
#                    aes(group=adjascent_neighbor,
#                        color=adjascent_neighbor,
#                        y=correct_rad_63_mean)) +
#         geom_line(data = mean_by_landmark_rep, 
#                   aes(group=adjascent_neighbor,
#                       color=adjascent_neighbor,
#                       y=correct_rad_63_mean),
#                   size=1) +
#         
#         facet_grid(ptp_trunk~condition*session) +
#         ggtitle(paste('Accuracy type: 63px radius',sep='')) +
#         theme(legend.position = 'none') +
#         xlab('Image repetition') +
#         scale_x_continuous(breaks=c(1,2,3,4))

print(fig)

```

```{r plot-averaged-over-participants, fig.width=15, fig.height=5}
# Now plot averaged over participants
mean_by_rep_across_ptp <-
        session_results_all_ptp %>%
        filter(!condition %in% c('practice','practice2')) %>%
        droplevels() %>%
        mutate(correct_rad_63 = coalesce(correct_rad_63,0)) %>%
        group_by(condition,session,new_pa_img_row_number) %>%
        summarize(correct_rad_63_mean = mean(correct_rad_63, na.rm = T),
                  correct_rad_63_sd = sd(correct_rad_63, na.rm = T),
                  n = n(),
                  correct_rad_63_95_CI = 1.96*sd(correct_rad_63)/sqrt(n())) %>%
        ungroup()

# Calculate mean for neighbor vs non neighbor, across participants
mean_by_landmark_rep_across_ptp <-
        session_results_all_ptp %>%
        filter(!condition %in% c('practice','practice2')) %>%
        droplevels() %>%
        mutate(correct_rad_63 = coalesce(correct_rad_63,0)) %>%
        group_by(condition,session,adjascent_neighbor,new_pa_img_row_number) %>%
        summarize(correct_rad_63_mean = mean(correct_rad_63, na.rm = T),
                  correct_rad_63_sd = sd(correct_rad_63, na.rm = T),
                  n = n(),
                  correct_rad_63_95_CI = 1.96*sd(correct_rad_63)/sqrt(n())) %>%
        ungroup() %>%
        mutate(correct_rad_63_mean = 
                       case_when(
                               is.na(adjascent_neighbor) ~ as.numeric(NA),
                               TRUE ~ correct_rad_63_mean
                       ),
               correct_rad_63_sd =
                       case_when(
                               is.na(adjascent_neighbor) ~ as.numeric(NA),
                               TRUE ~ correct_rad_63_sd
                       ),
               correct_rad_63_95_CI =
                       case_when(
                               is.na(adjascent_neighbor) ~ as.numeric(NA),
                               TRUE ~ correct_rad_63_95_CI
                       ),               
        )

fig_across_ptp <- mean_by_rep_across_ptp %>%
        ggplot(aes(x=new_pa_img_row_number,y=correct_rad_63_mean)) +
        geom_point(alpha=0.2) +
        geom_line(size=2) +
        geom_ribbon(aes(ymin = correct_rad_63_mean-correct_rad_63_95_CI,
                        ymax = correct_rad_63_mean+correct_rad_63_95_CI),
                    alpha=0.2) +        
        
        # # Add the average across toys
        # geom_point(aes(y=correct_rad_63_mean)) +
        # geom_line(aes(y=correct_rad_63_mean),
        #           size=2) +
        
        # # Add the average across landmark or not
        geom_point(data = mean_by_landmark_rep_across_ptp,
                   aes(group=adjascent_neighbor,
                       color=adjascent_neighbor,
                       y=correct_rad_63_mean)) +
        geom_line(data = mean_by_landmark_rep_across_ptp,
                  aes(group=adjascent_neighbor,
                      color=adjascent_neighbor,
                      y=correct_rad_63_mean),
                  size=1) +
        # geom_ribbon(data = mean_by_landmark_rep_across_ptp,
        #             aes(group=adjascent_neighbor,
        #                 color=adjascent_neighbor,
        #                 ymin = correct_rad_63_mean-correct_rad_63_95_CI,
        #                 ymax = correct_rad_63_mean+correct_rad_63_95_CI),
        #             alpha=0.1,
        #             linetype = "dotted") +

        facet_wrap(~condition*session, nrow = 1) +
        ggtitle(paste('Accuracy type: 63px radius',sep='')) +
        # theme(legend.position = 'none') +
        xlab('Image repetition') +
        scale_x_continuous(breaks=c(1,2,3,4)) +
        theme(legend.position = 'top')

print(fig_across_ptp)

```

```{r diff-between-neighbor-non-neighbor, fig.width=15, fig.height=4}

# Calculate the difference between landmark and non-landmark items
mean_diff_neighbor_non_neighbor <- 
        mean_by_landmark_rep %>%
        filter(condition != 'no_schema') %>%
        pivot_wider(id_cols = c(ptp_trunk,condition,session,new_pa_img_row_number),
                    names_from = adjascent_neighbor,
                    names_prefix = 'neighbor_',
                    values_from = correct_rad_63_mean) %>%
        mutate(neighbor_diff = neighbor_TRUE - neighbor_FALSE)
        
mean_diff_neighbor_non_neighbor_across_ptp <-
        mean_diff_neighbor_non_neighbor %>%
        group_by(condition,session,new_pa_img_row_number) %>%
        summarise(mean_diff_correct_rad_63 = mean(neighbor_diff),
                  n = n(),
                  ci_95 = 1.96*sd(neighbor_diff)/sqrt(n()))

# Plot the difference between landmark and non-landmark items
fig_neighbor_diff <- mean_diff_neighbor_non_neighbor_across_ptp %>%
        ggplot(aes(x=new_pa_img_row_number,y=mean_diff_correct_rad_63)) +
        geom_line(size=1) +
        geom_ribbon(aes(ymin = mean_diff_correct_rad_63 - ci_95,
                        ymax = mean_diff_correct_rad_63 + ci_95),
                    alpha = 0.2) +
        
        
        facet_wrap(~condition*session, nrow = 1) +
        geom_hline(yintercept = 0, linetype = 'dashed') +
        ggtitle('Difference between landmark neighbor and non-neighbor items') +
        ylab('Neighbor VS non-neighbor')

print(fig_neighbor_diff)

```
